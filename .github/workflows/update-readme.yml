name: Update README Progress

# This workflow runs on two triggers:
# 1. A push to the 'main' branch, but ONLY if files inside the 'modules/' directory were changed.
# 2. A manual trigger ('workflow_dispatch') from the GitHub Actions tab.
on:
  push:
    branches:
      - main
    paths:
      - "modules/**.md"
  workflow_dispatch:

jobs:
  update-readme:
    # This condition prevents an infinite loop. The workflow will not run if the commit is from the bot itself.
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    
    # Granting write permission to the GITHUB_TOKEN so the action can push changes back to the repository.
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Generate README Progress
        id: generate_readme
        run: |
          python3 <<'PY'
          import os, re, math, sys

          modules_dir = "modules"
          if not os.path.isdir(modules_dir):
              print(f"Directory '{modules_dir}' not found. Exiting.")
              sys.exit(0)

          module_titles = [
              "Module 1 - Introduction to the Cloud",
              "Module 2 - Compute in the Cloud",
              "Module 3 - Exploring Compute Services",
              "Module 4 - Going Global",
              "Module 5 - Networking",
              "Module 6 - Storage",
              "Module 7 - Databases",
              "Module 8 - AI, ML and Data Analytics",
              "Module 9 - Security",
              "Module 10 - Monitoring, Compliance and Governance in AWS Cloud",
              "Module 11 - Pricing and Support",
              "Module 12 - Migrating to the AWS Cloud",
              "Module 13 - Well-Architected Solutions"
          ]

          total = len(module_titles)
          completed = 0
          in_progress = 0
          table_rows = []

          # This regex finds a line starting with 'status:' (case-insensitive)
          # and captures the text that follows.
          status_re = re.compile(r"status\s*:\s*(.+)", flags=re.IGNORECASE)

          for idx, title in enumerate(module_titles, start=1):
              fname = f"module{idx:02d}.md"
              fpath = os.path.join(modules_dir, fname)
              status_text = "‚¨ú Not Started"

              if os.path.isfile(fpath):
                  with open(fpath, "r", encoding="utf-8") as fh:
                      content = fh.read()

                  m = status_re.search(content)
                  if m:
                      status_candidate = m.group(1).strip()
                      s_low = status_candidate.lower()

                      if "‚úÖ" in status_candidate or "completed" in s_low:
                          status_text = "‚úÖ Completed"
                          completed += 1
                      elif "üü°" in status_candidate or "in progress" in s_low:
                          status_text = "üü° In Progress"
                          in_progress += 1

              link = f"[Notes](<{modules_dir}/{fname}>)" if os.path.isfile(fpath) else "‚Äî"
              table_rows.append(f"| {idx} | {title} | {status_text} | {link} |")

          not_started = total - completed - in_progress

          # Progress is calculated with "In Progress" modules counting as half-complete.
          effective = completed + 0.5 * in_progress
          percent = math.floor((effective / total) * 100)

          badge = f"![Progress](https://img.shields.io/badge/Progress-{percent}%25-blue)"

          readme_content = (
              "# ‚òÅ AWS Cloud Practitioner Essentials ‚Äì Learning Tracker\n\n"
              "Automatically updated progress for the **AWS Cloud Practitioner Essentials** course.\n\n"
              "***\n\n"
              "## üìä Overall Progress\n"
              f"{badge}\n\n"
              f"**Completed:** {completed}/{total} ‚Ä¢ **In Progress:** {in_progress} ‚Ä¢ **Not Started:** {not_started}\n\n"
              "***\n\n"
              "## üìÇ Modules & Status\n"
              "| #  | Module Name | Status | Link |\n"
              "|----|-------------|--------|------|\n"
              + "\n".join(table_rows)
              + "\n"
          )

          with open("README.md", "w", encoding="utf-8") as fh:
              fh.write(readme_content)

          print("README.md updated.")
          PY

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if the README.md file was actually changed by the script
          if ! git diff --quiet README.md; then
            echo "Changes detected in README.md. Committing..."
            git add README.md
            git commit -m "docs: auto-update course progress"
            git push
          else
            echo "No changes to README.md. Skipping commit."
          fi