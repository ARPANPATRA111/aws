name: Update README Progress

on:
  push:
    branches:
      - main
    paths:
      - "modules/*.md"
  workflow_dispatch:

jobs:
  update-readme:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Generate README Progress
        run: |
          python3 <<'PY'
          import os, re, math, sys

          modules_dir = "modules"
          if not os.path.isdir(modules_dir):
              print(f"Directory '{modules_dir}' not found. Exiting.")
              sys.exit(0)

          # Expected 13 modules
          module_titles = [
              "Module 1 - Introduction to the Cloud",
              "Module 2 - Compute in the Cloud",
              "Module 3 - Exploring Compute Services",
              "Module 4 - Going Global",
              "Module 5 - Networking",
              "Module 6 - Storage",
              "Module 7 - Databases",
              "Module 8 - AI, ML and Data Analytics",
              "Module 9 - Security",
              "Module 10 - Monitoring, Compliance and Governance in AWS Cloud",
              "Module 11 - Pricing and Support",
              "Module 12 - Migrating to the AWS Cloud",
              "Module 13 - Well-Architected Solutions"
          ]

          total = len(module_titles)
          completed = 0
          in_progress = 0
          table_rows = []

          status_re = re.compile(r"\*{0,2}Status:\*{0,2}\s*(.*)", flags=re.IGNORECASE)

          for idx, title in enumerate(module_titles, start=1):
              fname = f"module{idx:02d}.md"
              fpath = os.path.join(modules_dir, fname)
              status_text = "â¬œ Not Started"

              if os.path.isfile(fpath):
                  with open(fpath, "r", encoding="utf-8") as fh:
                      content = fh.read()

                  m = status_re.search(content)
                  if m:
                      status_candidate = m.group(1).strip()
                      s_low = status_candidate.lower()

                      if "âœ…" in status_candidate or "completed" in s_low:
                          status_text = "âœ… Completed"
                          completed += 1
                      elif "ðŸŸ¡" in status_candidate or "in progress" in s_low:
                          status_text = "ðŸŸ¡ In Progress"
                          in_progress += 1

              link = f"[Notes]({modules_dir}/{fname})" if os.path.isfile(fpath) else "-"
              table_rows.append(f"| {idx} | {title} | {status_text} | {link} |")

          not_started = total - completed - in_progress

          # Weighted progress (in-progress = 0.5)
          effective = completed + 0.5 * in_progress
          percent = math.floor((effective / total) * 100)

          badge = f"![Progress](https://img.shields.io/badge/Progress-{percent}%25-blue)"

          readme = (
              "# â˜ AWS Cloud Practitioner Essentials â€“ Learning Tracker\n\n"
              "Automatically updated progress for the **AWS Cloud Practitioner Essentials** course.\n\n"
              "***\n\n"
              "## ðŸ“Š Overall Progress\n"
              f"{badge}\n\n"
              f"**Completed:** {completed}/{total} â€¢ **In Progress:** {in_progress} â€¢ **Not Started:** {not_started}\n\n"
              "***\n\n"
              "## ðŸ“‚ Modules & Status\n"
              "| #  | Module Name | Status | Link |\n"
              "|----|-------------|--------|------|\n"
              + "\n".join(table_rows)
              + "\n"
          )

          with open("README.md", "w", encoding="utf-8") as fh:
              fh.write(readme)

          print("README.md updated.")
          PY

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Auto-update README progress" || echo "No changes to commit"
          git push || echo "Push failed (possibly no new commits)"
